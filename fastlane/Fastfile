# Fastfile — TLingo App Store automation

default_platform(:ios)

# Shared helper: build App Store Connect API key
def asc_api_key
  app_store_connect_api_key(
    key_id: "Z2LZ4Y87BX",
    issuer_id: "69a6de8e-b1f0-47e3-e053-5b8c7c11a4d1",
    key_filepath: File.expand_path("~/Library/Mobile Documents/com~apple~CloudDocs/MacConfigs/AuthKey_Z2LZ4Y87BX.p8")
  )
end

platform :ios do

  # ─── Screenshots ───────────────────────────────────────────

  desc "Capture screenshots on all configured devices and languages"
  lane :screenshots do
    capture_screenshots(
      workspace: nil,
      project: "./AITranslator.xcodeproj",
      scheme: "TLingoUITests",
      output_directory: "./fastlane/screenshots",
      clear_previous_screenshots: false,
      override_status_bar: true,
      localize_simulator: true,
      dark_mode: false,
      concurrent_simulators: true,
      disable_slide_to_type: true,
      launch_arguments: ["-FASTLANE_SNAPSHOT"]
    )
  end

  desc "Add device frames and marketing text to screenshots"
  lane :frames do
    # Ensure gradient background exists
    bg_dir = "./fastlane/screenshots/backgrounds"
    bg_file = "#{bg_dir}/gradient.png"
    unless File.exist?(bg_file)
      FileUtils.mkdir_p(bg_dir)
      sh("magick -size 3200x3200 gradient:'#0a1628'-'#1a2744' '#{bg_file}'")
      UI.success("Generated gradient background at #{bg_file}")
    end

    frame_screenshots(
      path: "./fastlane/screenshots",
      force_device_type: nil # Auto-detect from filename
    )
  end

  desc "Capture screenshots, frame them, and upload to App Store Connect"
  lane :deliver_screenshots do
    screenshots
    frames
    upload_to_app_store(
      api_key: asc_api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      overwrite_screenshots: true,
      screenshots_path: "./fastlane/screenshots"
    )
  end

  desc "Upload existing framed screenshots to App Store Connect"
  lane :upload_only do
    upload_to_app_store(
      api_key: asc_api_key,
      app_identifier: "com.zanderwang.AITranslator",
      team_id: "JW2LR94V6G",
      skip_binary_upload: true,
      skip_metadata: true,
      overwrite_screenshots: true,
      screenshots_path: "./fastlane/screenshots",
      force: true,
      app_version: "2.0",
      run_precheck_before_submit: false
    )
  end

  desc "Full screenshot pipeline: capture, frame, and upload"
  lane :full_pipeline do
    deliver_screenshots
  end

  # ─── Metadata ──────────────────────────────────────────────

  desc "Download metadata from App Store Connect to local metadata/ directory"
  desc "Usage: fastlane deliver download_metadata --api_key_path ./fastlane/api_key.json"
  desc "Note: api_key.json must contain key_id, issuer_id, key (inline p8 content), in_house fields"
  lane :download_metadata do
    UI.message("Run directly via CLI:")
    UI.message("  fastlane deliver download_metadata --api_key_path ./fastlane/api_key.json")
    UI.message("")
    UI.message("Or generate api_key.json first, then run this lane.")
  end

  desc "Upload all metadata (description, keywords, what's new, etc.) to App Store Connect"
  lane :upload_metadata do
    upload_to_app_store(
      api_key: asc_api_key,
      app_identifier: "com.zanderwang.AITranslator",
      team_id: "JW2LR94V6G",
      skip_binary_upload: true,
      skip_screenshots: true,
      metadata_path: "./fastlane/metadata",
      force: true,
      run_precheck_before_submit: false
    )
  end

  # ─── Combined ──────────────────────────────────────────────

  desc "Full release: upload metadata + screenshots"
  lane :release do
    upload_to_app_store(
      api_key: asc_api_key,
      app_identifier: "com.zanderwang.AITranslator",
      team_id: "JW2LR94V6G",
      skip_binary_upload: true,
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots",
      overwrite_screenshots: true,
      force: true,
      run_precheck_before_submit: false
    )
  end

end
